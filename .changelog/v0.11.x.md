# Release v0.11.x - Changelog

Released: YYYY-MM-DD

## Overview

This release focuses on security improvements, bug fixes for the AI runner system, and enhanced AI provider model management.

## üéâ Features

### Universal Model Refresh for AI Providers
- **Model Refresh Button**: Added "Refresh Models" button to AI providers on the `/devtools/providers` page
- **Multi-Provider Support**: Refresh now works for both API and CLI providers including:
  - API providers: OpenAI, LM Studio, Ollama (with provider-specific endpoint detection)
  - CLI providers: Claude/Anthropic (returns latest model list)
- **Smart UI**: Button is hidden for providers that don't require model specification (e.g., Gemini CLI)
- **User Feedback**: Toast notifications show success/failure messages with descriptive error handling
- **Loading States**: Button shows "Refreshing..." state during model fetch operations
- **Graceful Degradation**: Providers without refresh support show appropriate error messages

**Implementation Details**:
- Updated `portos-ai-toolkit` to support provider-specific refresh strategies
- Added `_refreshAPIProviderModels()` for API-based providers with multi-format support
- Added `_refreshCLIProviderModels()` with provider detection and API integration
- Client shows refresh button for all providers (previously API-only)
- Enhanced error handling with user-friendly toast notifications

**Files Modified**:
- `portos-ai-toolkit/src/server/providers.js` - Universal refresh implementation
- `client/src/pages/AIProviders.jsx` - UI updates with toast notifications

### Digital Twin AI Interview Chat
- New "Interview" tab in Digital Twin for building personality profiles via external AI conversation loops
- Paste personality data from ChatGPT/other AIs for automated analysis and twin record updates
- AI-powered follow-up question generation to deepen profile coverage
- Persistent chat sessions with session management (create, rename, delete)
- Automatically maps traits to Big Five, values, and communication dimensions
- Creates new documents for trait categories not yet captured (Cognitive, Creative, Technical, etc.)
- Linkable sessions via URL query params (`/digital-twin/interview?session=<uuid>`)

## üêõ Bug Fixes

### CLI Runner Security & Reliability
- **Security Warning Fix**: Resolved Node.js DEP0190 deprecation warning in CLI runner by removing unsafe `shell: true` option from child process spawning
- **Improved Argument Handling**: CLI commands now use direct argument passing instead of shell interpretation, preventing potential security vulnerabilities from unescaped arguments
- **Enhanced Logging**: Added detailed logging for CLI execution showing full command and prompt preview to aid debugging
- **Context**: The `/devtools/runner` page was generating security warnings when executing Claude CLI commands. The fix removes shell interpretation which was unnecessary and insecure, while maintaining full functionality

**Technical Details**:
- Created override in `server/services/runner.js` for `executeCliRun()` function
- Removed `shell: true` option from `spawn()` call (recommended by Node.js security guidelines)
- Arguments are now properly passed as array without shell metacharacter interpretation
- Added runtime patching in `server/index.js` to inject fixed implementation into AI toolkit

**Files Modified**:
- `server/services/runner.js` - New secure CLI execution implementation
- `server/index.js` - Runtime patching to override toolkit's runner

### Brain Inbox Classification Hang on Capture
- **Background Classification**: Brain inbox thought capture now returns immediately instead of blocking the UI while waiting for AI classification
- **Real-time Updates**: Classification results are pushed to the client via Socket.IO events (`brain:classified`), with toast notifications showing the result
- **New "Classifying" Status**: Added `classifying` status with animated UI indicator so users can see thoughts being processed in real time
- **No More Hangs**: Previously, submitting a thought would hang the UI spinner indefinitely if the AI provider was slow or unresponsive. Now the thought is saved instantly and classified in the background

**Files Modified**:
- `server/services/brain.js` - Split `captureThought` into immediate return + background `classifyInBackground`
- `server/services/socket.js` - Added brain event forwarding via `setupBrainEventForwarding`
- `server/lib/brainValidation.js` - Added `classifying` to inbox status enum
- `server/services/brainStorage.js` - Added `classifying` to inbox log counts
- `client/src/components/brain/tabs/InboxTab.jsx` - Socket.IO listener for classification results, classifying section UI
- `client/src/components/brain/constants.js` - Added `classifying` status color

### Killed Tasks No Longer Requeue
- **DevTools Kill Integration**: Killing a CoS agent via the DevTools process manager (`DELETE /api/agents/:pid`) now delegates to the CoS `killAgent()` function, which properly blocks the task instead of letting the close handler treat it as a retryable failure
- **Immediate Task Blocking**: Both `terminateAgent()` and `killAgent()` in direct mode now immediately update the task to `blocked` with `user-terminated` category, matching the runner mode behavior. Previously, task blocking was deferred to the close handler, creating a window where server restarts could cause requeue
- **Orphan Handler Guard**: `handleOrphanedTask()` now skips tasks already marked as `user-terminated`, preventing any residual requeue path

### Autofixer App Replaced with PortOS Default
- Replaced the standalone Autofixer app with PortOS default app in sample data to avoid confusion

### Immediate Task Execution for User Tasks
- **Instant Spawn**: User-submitted tasks now start immediately when agent slots are available, instead of waiting up to 60 seconds for the next evaluation interval
- **Slot-Free Dequeue**: When an agent completes and frees a slot, the next pending task is immediately dequeued and spawned without waiting for the evaluation cycle
- **Priority Preserved**: Dequeue on slot free checks user tasks first, then auto-approved system tasks, maintaining the existing priority order
- **Evaluation Interval Preserved**: The periodic evaluation interval continues to handle system task generation, idle reviews, and mission tasks ‚Äî immediate execution is specifically for dequeuing pending work

## üîß Improvements

### Live Output Streaming for Claude CLI Agents
- **Real-time Feedback**: Claude CLI agents now stream output in real-time as they work, matching the live output experience previously only available with Codex
- **Stream-JSON Parsing**: Uses Claude CLI's `--output-format stream-json --verbose --include-partial-messages` flags to receive incremental text deltas as they're generated
- **Tool Use Visibility**: Shows tool invocations (e.g., "üîß Using Edit...") in the live output so users can see what the agent is doing
- **Both Spawn Modes**: Works in both direct spawn mode and via the standalone CoS Runner (PM2 process)
- **Clean Output Files**: The final output file contains the clean result text, while the raw JSON stream is preserved for error analysis
